# 供应链网络深度优先搜索策略的优化及其可视化分析机制研究

## 摘要

本文致力于提出一种针对复杂供应链网络路径发现的改良深度优先搜索（DFS）算法，并整合多维可视化技术，以期揭示其内在结构特性与动态演化模式。文中详尽阐述了所构建的DFS算法在供应链特定情境下的运作机理，包括为提升分析精度而引入的若干关键性改良，诸如中国市场关联度约束、时序逻辑连续性检验以及路径冗余过滤机制，均辅以形式化表达。进一步，探讨了如何借助量化指标体系及地理空间映射技术，对供应链的关键动态事件——例如中断、转移与恢复过程——进行直观呈现与深度解析。本研究构建的方法论框架及配套分析工具，为深刻理解全球供应链系统之韧性，特别是洞察与中国相关的供应链网络动态，提供了具有理论意义与应用价值的分析途径。

## 1. 引言

在全球化经济背景下，供应链系统呈现出前所未有的复杂性与动态性，对该系统进行精准分析与深刻理解，已成为企业战略决策与宏观经济研究不可或缺的核心议题。传统供应链分析范式在面对长链条、多层级交织的复杂依存关系时，往往显得力有不逮。深度优先搜索（DFS），作为图论中一种经典的遍历策略，为系统性探查并枚举供应链潜在路径提供了理论基础。然而，标准DFS算法应用于供应链分析时，其效能与针对性均需通过特定改良方能满足研究需求。

本文的核心研究目标可概括为：
1.  系统阐释一种经过改良的深度优先搜索算法，该算法旨在从海量、异构的供应链关系数据中，高效提取具有分析价值的供应链路径。
2.  详细介绍一种综合性的方法论，用于对提取的供应链路径及其时变状态进行量化评估与多维可视化展呈，其中重点关注对供应链稳定性产生显著影响的事件，包括但不限于中断、转移及恢复等现象。
3.  从经济学与统计学交叉的学科视角，深入探讨此方法在剖析特定地缘经济区域（例如中国及其关联经济体）供应链网络动态特征方面所展现的应用潜力与理论贡献。

## 2. 基于改良深度优先搜索的供应链路径识别框架

本研究采用在 [`SupplyChainAnalyzer`](component/company_supplyChain.py) 类中实现的 `find_supply_chains` 方法作为供应链路径发现的核心引擎。该方法以深度优先搜索（DFS）算法为理论基石，并针对供应链网络的固有特性实施了系列适应性优化与功能增强。

### 2.1 供应链网络的图论表示

我们将供应链网络抽象为一个有向图 $G=(V, E)$，其中：
-   $V$ 代表网络中所有参与公司的集合。每个公司实体 $c \in V$ 均被赋予一系列属性，包括唯一的公司标识符 (ID) 及国家代码 (`country`) 等。
-   $E$ 代表供应链中所有直接供应关系的集合。每条关系 $r \in E$ 连接两个公司节点 $(c_{from}, c_{to})$，其中 $c_{from}$ 为供应方，$c_{to}$ 为需求方。关系 $r$ 同时承载了时间戳信息（如关系起始时间 `start` 和结束时间 `end`）以及关系状态（`status`，例如 "active", "permanent_break" 等）。这些关系由 [`SupplyRelation`](component/company_supplyChain.py) 类进行实例化表征。

### 2.2 深度优先搜索核心机制与控制参数

DFS算法的执行始于图 $G$ 中的每一个潜在起始公司节点，通过递归方式深度探索所有可达的供应链路径。算法的关键控制参数设定如下：
-   $L_{min}$: 定义一条有效供应链路径所必须包含的最小关系段数量，即路径长度的下限。
-   $D_{max}$: DFS算法在探索过程中允许的最大递归深度，用以约束路径的最大长度。
-   `start_index`, `end_index`: 此二参数用于对起始节点的处理进行分段，旨在提升算法在处理超大规模图数据时的可伸缩性与效率。

递归函数 `dfs(current_company, path, visited_companies, last_end)` 构成了搜索的核心，其参数释义为：
-   `current_company` ($c_{curr}$): 当前递归层级正在访问的公司节点。
-   `path` ($P_{curr}$): 一条从初始节点延伸至 $c_{curr}$ 的当前路径，由一个 [`SupplyRelation`](component/company_supplyChain.py) 对象的有序序列构成。
-   `visited_companies` ($V_{visited}$): 一个集合，记录了 $P_{curr}$ 中所有已访问的公司节点，其主要功能是避免在搜索过程中陷入循环路径。
-   `last_end` ($t_{prev\_end}$): 路径 $P_{curr}$ 中上一段关系 $r_{prev}$ 的结束时间戳。

### 2.3 关键改良策略与约束条件的形式化表达

为使DFS算法更契合供应链分析的独特需求，我们引入了以下几项关键的改良措施与约束条件：

**1. 中国市场关联度检验 (China-Nexus Filter)**

一条被识别的供应链路径 $P = (r_1, r_2, \ldots, r_k)$，其中 $r_j = (c_{j,\text{from}}, c_{j,\text{to}})$，被判定为与中国市场相关，当且仅当该路径中至少存在一个关系段 $r_j \in P$ 满足如下条件：

$\exists r_j \in P \text{ s.t. } \left(\text{Country}(c_{j,\text{from}}) = \text{'CN'}\right) \lor \left(\text{Country}(c_{j,\text{to}}) = \text{'CN'}\right)$

其中 $\text{Country}(c)$ 表示公司 $c$ 的注册国家代码。此约束确保了分析的焦点集中于那些与中国经济体发生直接或间接联系的供应链。该检验逻辑在 [`find_supply_chains`](component/company_supplyChain.py) 方法的DFS辅助函数内部实现，于路径长度 $|P|$ 达到预设的 $L_{\min}$ 时触发。

**2. 时序连续性约束 (Temporal Continuity Constraint)**

对于路径 $P$ 中任意两个在拓扑结构上相邻的关系段 $r_i$ 和 $r_{i+1}$（其中 $r_i$ 的结束时间对应于 $t_{\text{prev\_end}}$），它们在时间维度上必须满足连续性或有效的接续关系，形式化表达为：

$r_{i+1}.\text{start} \geq r_i.\text{end}$

此约束保证了所构建供应链在时间序列上的逻辑一致性与现实可能性。

**3. 环路规避机制 (Cycle Prevention Mechanism)**

通过维护并查询 $V_{\text{visited}}$ 集合，算法能够有效追踪当前路径 $P_{\text{curr}}$ 上的已访问公司。若计划扩展的下一关系 $r_{\text{next}}$ 的目标公司 $r_{\text{next}}.\text{to\_co}$ 已存在于 $V_{\text{visited}}$ 中，则判定发生路径环路，算法将终止沿此方向的进一步深化探索。

$\text{IsCycle}(r_{\text{next}}.\text{to\_co}, V_{\text{visited}}) = \left(r_{\text{next}}.\text{to\_co} \in V_{\text{visited}}\right)$

**4. 路径长度界限 (Path Length Constraints)**

路径的有效性与探索深度受到长度参数的严格控制。一条路径 $P$ 被初步接纳并记录，需同时满足长度条件 $|P| \geq L_{\min}$ 及前述的中国市场关联度检验 $\mathcal{C}(P)$。若路径长度 $|P|$ 达到预设的上限 $D_{\max}$，则对该路径的进一步延伸将被终止。

$\text{RecordIf}\left(|P| \geq L_{\min} \land \mathcal{C}(P)\right)$

$\text{StopIf}\left(|P| \geq D_{\max}\right)$

**5. 冗余路径剔除策略 (`filter_duplicate_chains`)**

在初步收集所有满足上述条件的候选路径之后，系统将调用 [`filter_duplicate_chains`](component/company_supplyChain.py) 方法执行后处理优化。该方法首先将所有候选路径集合 $\mathcal{P}_{\text{cand}}$ 按其包含的关系数量（即路径长度）进行降序排列。随后，算法迭代遍历排序后的路径。对于任一新考察路径 $P_{\text{new}} \in \mathcal{P}_{\text{cand}}$，令其关系集合为 $R(P_{\text{new}}) = \{r \mid r \in P_{\text{new}}\}$。只有当 $R(P_{\text{new}})$ 不完全被已筛选并保留的路径集合 $S_{\text{filtered}}$ 中所有路径的关系之并集所包含时，$P_{\text{new}}$ 才会被最终保留：

$P_{\text{new}} \text{ is retained if } R(P_{\text{new}}) \not\subseteq \bigcup_{P_i \in S_{\text{filtered}}} R(P_i)$

此策略旨在优先保留信息量更大、结构更完整的长链条，有效避免了因短路径是长路径的子片段而导致的信息冗余与分析偏差。

这些精心设计的改良机制，使得DFS算法能够从原始的、往往庞杂且充满噪声的供应链数据中，高效、准确地抽取出结构清晰、时序连贯，并且与特定分析目标（例如，与中国市场高度相关的供应链）紧密耦合的路径信息。

## 3. 供应链状态的可视化分析与解读机制

在通过改良DFS算法成功识别出相关供应链路径之后，本研究进一步采用 [`2.可视化代码_外资在华统计.py`](统计外资在华企业的可视化表/2.可视化代码_外资在华统计.py) 中编码实现的逻辑，对这些路径进行深入的状态分析与地理空间维度上的可视化呈现。

### 3.1 供应链路径的甄选与时序切片化处理

**1. 目标企业关联路径筛选 (`delete_relation`)**:
在进入可视化流程之前，首要步骤是对已发现的供应链条进行目标导向的筛选。一条供应链 $P$ 得以保留并进入后续分析，其充要条件是该链中至少存在一个供应关系 $r=(c_{from}, c_{to}) \in P$，使得关系中的某个参与公司 $c_{involved} \in \{c_{from}, c_{to}\}$ 满足以下复合判据：
$ (CN \in H(c_{involved})) \land (\mathcal{C}_o(c_{involved}) \neq \{CN\}) $
其中，$H(c)$ 代表公司 $c$ 的注册地或主要运营区域集合，而 $\mathcal{C}_o(c)$ 代表公司 $c$ 的国别属性集合。此条件旨在精确识别那些在中国境内拥有投资或显著运营活动（体现为 $H(c_{involved})$ 包含 'CN'），但其并非纯粹由中国资本构成或完全代表中国本土利益（体现为 $\mathcal{C}_o(c_{involved})$ 不仅只包含 'CN'）的企业所深度参与的供应链条。通过此筛选，分析焦点得以有效地集中于与在华外资企业或中外合资企业紧密相关的供应链网络。

**2. 路径时序化表征 (`generate_path_lines`)**:
此函数负责将经过上述筛选的供应链路径，在用户指定的特定时间窗口 $[T_{start}, T_{end}]$ 内的活跃关系段进行结构化与格式化处理。对于每一条符合条件的供应链，该函数将提取在此时间窗口内所有有效的关系分段，并将它们整合为一个具有明确语义的字符串序列。例如，形如：
`"CompanyA→CompanyB(status1) → CompanyB→CompanyC(status2)[FinalChainStatus]"`
的表述中，`status_i` 指代单个供应关系 $r_i$ 的内部状态属性，而 `FinalChainStatus` 则表征了整个链条在观察期结束时的综合最终状态。

### 3.2 供应链状态的量化评估模型 (`analyze_paths`)

此核心函数负责解析由 `generate_path_lines` 生成的路径字符串序列，进而统计在不同国家或地区配对之间，处于特定预定义状态下的供应链关系的聚合强度。本研究重点关注以下几种关键状态：
-   永久性中断 ($B_p$): Denoting a permanent cessation of the supply link.
-   转移 ($T_r$): Indicating a shift of the supply relationship to a new entity or location.
-   恢复 ($R_c$): Representing the re-establishment of a previously disrupted link.

**状态权重赋值模型**:
对于每一种考察的状态 $S \in \{B_p, T_r, R_c\}$，以及任意一个国家/地区对 $(Country_X, Country_Y)$，其间的聚合状态权重 $W_{XY}^S$ 通过以下方式进行量化计算：

-   **永久性中断 ($B_p$) 权重计算**:
    中断事件的权重赋值不仅考虑了其在所属供应链条中所处的“层级”（layer），亦区分了是否为“时限性中断” (`limit_day_break`)。其形式化表达为：
    $ W_{XY}^{B_p} = \sum_{p \in \mathcal{P}_{selected}} \sum_{s \in p, s.from\_co.country=X, s.to\_co.country=Y, s.status=B_p} \omega_{layer}(s, p) \cdot \lambda(p,s) $
    其中：
    -   $\mathcal{P}_{selected}$ 代表所有经过筛选和时序切片后的路径集合。
    -   $s$ 代表路径 $p$ 中的一个状态为 $B_p$ 的中断关系段。
    -   $\omega_{layer}(s, p)$ 是一个依赖于中断段 $s$ 在路径 $p$ 中所处层级 $\ell(s,p)$（从1开始计数）以及路径 $p$ 是否为时限中断 ($\text{is\_limit\_break}(p)$) 的权重函数。具体而言，$\omega_{layer}(s, p) = f_{\omega}(\ell(s,p), \text{is\_limit\_break}(p))$，其中 $f_{\omega}(\ell, \text{false}) = \{1.0 \text{ if } \ell=1; 0.5 \text{ if } \ell=2; 0.1 \text{ if } \ell=3; 0 \text{ otherwise}\}$，而 $f_{\omega}(\ell, \text{true}) = \{1.0 \text{ if } \ell=1; 0.7 \text{ if } \ell=2; 0.4 \text{ if } \ell=3; 0 \text{ otherwise}\}$。
    -   $\lambda(p,s)$ 是一个调整因子。若路径 $p$ 的最终状态 $\text{final\_status}(p)$ 为 'limit\_day\_break'，且当前处理的断裂段 $s$ 恰好是路径 $p$ 的末端关系 $s_{last}$，并且 $s_{last}$ 本身的状态并非 $B_p$，则 $\lambda(p,s) = 0.1$；在其他所有情况下，$\lambda(p,s) = 1$。此因子旨在对因观察期截止而造成的名义中断与结构性真实中断进行区分。

-   **转移 ($T_r$) 与恢复 ($R_c$) 状态权重**:
    对于转移和恢复这两种状态，其权重通常采用事件计数法。即，每当一个关系段被识别为此类状态时，其对相应国家对的权重贡献计为1。
    
$ W_{XY}^{S} = \sum_{p \in \mathcal{P}_{selected}} \sum_{s \in p} \mathbb{I}(s.from\_co.country = X \land s.to\_co.country = Y \land s.status = S)$

其中 $S \in \{T_r, R_c\}$，$\mathbb{I}(\cdot)$ 为指示函数，当括号内条件为真时取值为1，否则为0。

### 3.3 地理空间可视化策略 (`create_map_figure`)

本研究采用Plotly交互式可视化库，生成地理热力图，用以直观展示前述量化状态指标。

**1. 节点的地理映射与关系的视觉连接**:
   -   各个国家或地区在世界地图上被抽象为地理节点，其精确的经纬度坐标来源于一个预先定义的 `country_coords` 字典。
   -   任意国家对 $(Country_X, Country_Y)$ 之间，其在特定状态 $S$ 下的聚合权重 $W_{XY}^S$，通过在地图上连接对应节点的有向线段进行视觉表征。

**2. 视觉编码规范**:
   -   **色彩映射**: 不同状态的供应链连接线段被赋予独特的颜色编码，以增强视觉区分度。例如，状态 $B_p$（永久性中断）的连线通常呈现为红色，状态 $T_r$（转移）为绿色，而状态 $R_c$（恢复）则为黄色。
   -   **线宽量度**: 连线的宽度 $L_W$ 被设计为与其承载的权重 $W_{XY}^S$ 的相对大小成正比。具体实现上，通常是将所有权重值 $W_{XY}^S$ 归一化或进行分位数划分，然后映射到一组预设的离散线宽等级。令 $w'_{XY_S} = W_{XY}^S / \sum_{X',Y'} W_{X'Y'}^S$ 为相对权重，则线宽 $L_W(w'_{XY_S}) = w_k$ 若 $q_{k-1} < w'_{XY_S} \le q_k$，其中 $q_k$ 代表预定义的权重分位数阈值，$w_k$ 是对应的线宽值，取自预设列表 `line_width_list`。

**3. 特殊情境处理与用户交互功能**:
   -   **中国内部关系的视觉区分**: 对于起始地和目的地均为中国大陆 ("CN" 到 "CN") 的供应链关系，其目标点在地图上的渲染坐标会被微调至一个预设的 `CN_2` 坐标点。此举旨在视觉上区分纯粹的中国国内供应链流转与涉及中国的国际供应链流转的起始端。
   -   **核心区域聚焦显示**: 可视化界面允许用户通过 `country_show_list` 参数（例如，设定为包含 'CN', 'HK', 'TW', 'MO' 等）来限定关注的地理范围，从而仅展示与这些核心国家或地区相关的供应链连接          。
   -   **交互式图例控制**: 用户可以通过点击图例中的条目，动态选择或隐藏特定状态下的供应链连接，从而实现对复杂图谱的聚焦分析。

此套可视化方法论，能够将抽象的供应链状态数据转化为直观的地理空间模式，有效地揭示全球供应链网络中不同区域间在特定状态下的连接强度、分布格局与潜在的演化路径，为识别关键供应链枢纽、评估网络脆弱性以及洞察动态变迁趋势提供了强有力的支持。

## 4. 讨论：理论意涵与应用前景

本文所构建的改良型DFS算法及配套可视化机制，为深度剖析复杂供应链网络提供了创新性的分析工具集。
-   **学术层面的贡献**: 该方法论有机融合了图论算法的严谨性与统计可视化的直观性，为供应链研究领域贡献了一个标准化的路径发现与模式识别分析框架。通过对传统DFS算法进行针对性的改良——包括引入中国市场关联度、时序逻辑约束及路径去冗余等关键环节——使其能更好地适应供应链数据所固有的时间、空间及结构异质性。权重动态量化模型与分层分色可视化策略的引入，使得对复杂网络动态演化过程的解读更为精准、直观且富有洞察力。
-   **经济学领域的应用潜能**:
    -   **产业转移路径与强度的量化追踪**: 通过对 `transfer` 状态的地理空间分布及其权重演变的持续追踪与分析，能够量化特定历史时期内，产业活动由一国向另一国（或一区域向另一区域）转移的实际趋势与规模。
    -   **供应链系统韧性与脆弱性评估**: 对 `permanent_break` 和 `recovered` 状态的深入分析，有助于评估供应链在遭遇外部冲击（例如，地缘政治冲突、大规模自然灾害、突发性政策调整等）时的固有脆弱性及其自我修复与恢复常态的综合能力。例如，通过比较特定贸易政策（如关税壁垒调整）实施前后，中美两国间表征 `permanent_break` 状态的连接权重 $W_{CN,US}^{B_p}$ 的显著变化，可以定量评估该政策对双边供应链稳定性的具体影响程度。
    -   **区域性供应链中心度与辐射力分析**: 借助 `country_show_list` 参数将分析视域聚焦于特定国家（例如中国），可以系统地评估其在全球供应链网络中的核心枢纽地位、对外辐射能力，以及与其他主要经济体之间形成的复杂依赖关系与互动格局。
-   **内置优化机制的效能**:
    -   DFS算法的多维度改良（中国市场关联度筛选、时序一致性检验、冗余路径剔除）确保了所提取供应链路径的分析有效性与主题相关性，同时显著降低了不必要的计算开销与信息噪音。
    -   在 `analyze_paths` 函数中引入的分层权重体系以及对 `limit_day_break` 特殊情况的审慎处理，使得对供应链中断事件的解读更具层次感与辨识度，能够有效区分不同性质、不同层级影响下的中断效应。
    -   可视化模块中采用的线宽与颜色动态编码方案，成功地将高度抽象的统计数据转化为易于人类感官系统理解和接受的地理空间模式，极大地增强了从复杂数据中提取有价值洞察的能力。

## 5. 结论与展望

本文系统地阐述了一套整合了改良型深度优先搜索算法与多维交互式可视化技术的供应链分析方法论。通过对DFS算法进行一系列针对性的优化与增强，我们成功实现了从大规模、高维度原始数据中高效提取具有明确经济学与统计学意义的供应链路径。进一步，结合精细化的状态量化模型与直观的地理空间可视化技术，本方法能够清晰地展示全球供应链网络的宏观结构特征、微观动态演变过程及其在不同预设状态下所呈现出的区域间连接强度与模式。此研究不仅为深刻理解和有效应对当前日益复杂且变动不居的全球供应链环境提供了重要的分析视角，亦为相关领域的决策制定与风险管理提供了有力的技术支撑。未来的研究工作可考虑将更多维度的企业属性与关系特征融入分析框架，例如企业的财务状况、技术水平、ESG表现等，并探索结合机器学习与网络科学的前沿方法，以期实现对供应链潜在风险点与演化趋势的预测性分析。
